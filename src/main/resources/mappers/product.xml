<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.test.teamproject_back.repository.ProductMapper">
    <resultMap id="productResultMap" type="org.test.teamproject_back.entity.Product">
        <id property="productId" column="product_id"></id>
        <result property="title" column="title"></result>
        <result property="price" column="price"></result>
        <result property="stock" column="stock"></result>
        <result property="salesCount" column="sales_count"></result>
        <result property="description" column="description"></result>
        <result property="origin" column="origin"></result>
        <result property="thumbnailImg" column="thumbnail_img"></result>
        <result property="contentsImg" column="contents_img"></result>
        <result property="createdDate" column="created_date"></result>
        <collection property="productCategories" javaType="java.util.Set" resultMap="productCategoryResultMap"></collection>
    </resultMap>
    <resultMap id="productCategoryResultMap" type="org.test.teamproject_back.entity.ProductCategory">
        <id property="productCategoryId" column="product_category_id"></id>
        <result property="productId" column="pct_product_id"></result>
        <result property="categoryId" column="pct_category_id"></result>
        <association property="category" resultMap="categoryResultMap"></association>
    </resultMap>
    <resultMap id="categoryResultMap" type="org.test.teamproject_back.entity.Category">
        <id property="categoryId" column="ct_category_id"></id>
        <result property="name" column="name"></result>
    </resultMap>

    <insert id="addProduct" useGeneratedKeys="true" keyProperty="productId">
        insert into products_tb (product_id, title, price, stock, description, origin, thumbnail_img, contents_img, created_date)
        values(
            0, #{title}, #{price}, #{stock}, #{description}, #{origin}, #{thumbnailImg}, #{contentsImg}, now()
        )
    </insert>
    <insert id="addCategory" useGeneratedKeys="true" keyProperty="categoryId">
        insert into categories_tb
        values (0, #{name})
    </insert>
    <insert id="addProductCategory">
        insert into product_category_tb
        values(0, #{productId}, #{categoryId})
    </insert>
    <update id="updateProduct">
        update products_tb
        set
            title = #{title},
            price = #{price},
            stock = #{stock},
            description = #{description},
            origin = #{origin},
            thumbnail_img = #{thumbnailImg},
            contents_img = #{contentsImg}
        where
            product_id = #{productId}
    </update>
    <update id="updateProductCategory">
        update product_category_tb
        set
            category_id = #{categoryId}
    </update>
    <delete id="deleteProductById">
        delete from products_tb
        where
            product_id = #{productId}
    </delete>
    <delete id="deleteProductCategoryById">
        delete from product_category_tb
        where
            product_id = #{productId}
    </delete>
    <select id="findProductByTitle" resultMap="productResultMap">
        select
            pt.product_id,
            pt.title,
            pt.price,
            pt.stock,
            pt.sales_count,
            pt.description,
            pt.origin,
            pt.thumbnail_img,
            pt.contents_img,
            pt.created_date,
            ct.category_id as ct_category_id,
            ct.name,
            pct.product_category_id,
            pct.product_id as pct_product_id,
            pct.category_id as pct_category_id
        from
            products_tb pt
            left outer join product_category_tb pct on (pt.product_id = pct.product_id)
            left outer join categories_tb ct on (pct.category_id = ct.category_id)
        where
            pt.title like concat('%',trim(ifnull(#{title},'')),'%')
    </select>
    <select id="findProductById" resultType="org.test.teamproject_back.entity.Product">
        select
            *
        from
            products_tb
        where
            product_id = #{id}
    </select>
    <select id="getAllProductsList" resultMap="productResultMap">
        select
            pt.product_id,
            pt.title,
            pt.price,
            pt.stock,
            pt.sales_count,
            pt.description,
            pt.origin,
            pt.thumbnail_img,
            pt.contents_img,
            pt.created_date,
            ct.category_id as ct_category_id,
            ct.name,
            pct.product_category_id,
            pct.product_id as pct_product_id,
            pct.category_id as pct_category_id
        from
            products_tb pt
            left outer join product_category_tb pct on (pt.product_id = pct.product_id)
            left outer join categories_tb ct on (pct.category_id = ct.category_id)
    </select>
</mapper>